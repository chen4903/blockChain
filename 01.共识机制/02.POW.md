## **Pow**

 中本聪在其比特币奠基性论文中设计了PoW 共识机制，其核心思想是通过引入分布式节点的算力竞争来保证数据一致性和共识的安全性。 比特币系统中, 各节点 (即矿工) 基于各自的计算机算力相互竞争来共同解决一个求解复杂但验证容易的 SHA256 数学难题 (即挖矿)， 最快解决该难题的节点将获得区块记账权和系统自动生成的比特币奖励。 该数学难题可表述为: 根据当前难度值, 通过搜索求解一个合适的随机数 (Nonce) 使得区块头各元数据的双 SHA256 哈希值小于或等于目标哈 希值。在节点成功找到满足的Hash值之后，会马上对全网进行广播打包区块，网络的节点收到广播打包区块，会立刻对其进行验证。比特币系统通过灵活调整随机数搜索的难度 值来控制区块的平均生成时间为 10 分钟左右。

### 工作流程

工作量证明最核心的技术原理是散列函数（哈希）。散列函数的特征其实就是将任意长度的数作为输入然后通过散列函数的运算后得到一个固定长度值的输出，这个值就是散列值（哈希值）。

**pow工作量证明的流程如下：**

1. 生成Merkle根哈希：生成Merkle根哈希在第二章节中的第2要素中已经有讲解，即节点自己生成一笔筹币交易，并且与其他所有即将打包的交易通过Merkle树算法生成Merkle根哈希，所以为什么说区块是工作量证明的三要素之一。
2. 组装区块头：区块头将被作为计算出工作量证明输出的一个输入参数，因此第一步计算出来的Merkle根哈希和区块头的其他组成部分组装成区块头，这也就是为什么我们在前言中大费周章的去提前讲解比特币的区块头。
3. 计算出工作量证明的输出：下面我们直接通过公式和一些伪代码去理解工作量证明的输出： 
   1. 工作量证明的输出=SHA256(SHA256(区块头))
   2. if（工作量证明的输出<目标值），证明工作量完成
   3. if（工作量证明的输出>=目标值）,变更随机数，递归i的逻辑，继续与目标值比对。

![img](D:/blockchain_github/01.共识机制/imags/a1.png)

图1：来自网络 

**一般说来， PoW 共识的随机数搜索过程如下：**

1.  搜集当前时间段的全网未确认交易, 并增加一个用于发行新比特币奖励的 Coinbase 交易, 形成当前区块体的交易集合;
2.  计算区块体交易集合的Merkle根记入区块头, 并填写区块头的其他元数据, 其中随机数 Nonce 置零;
3.  随机数 Nonce 加 1; 计算当前区块头的双 SHA256 哈希值, 如果小于或等于目标哈希值, 则成功搜索到合适的随机数并获得该区块的记账权; 否则继续步骤 3 直到任一节点搜索到合适的随机数 为止;
4.  如果一定时间内未成功, 则更新时间戳和未确认交易集合、重新计算 Merkle 根后继续搜索。

符合要求的区块头哈希值通常由多个前导零构成，目标哈希值越小, 区块头哈希值的前导零越多, 成功找到合适的随机数并 “挖” 出新区块的难度越大。 据区块链实时监测网站 Blockchain.info 显示， 截止到 2016 年 2 月，符合要求的区块头哈希值一 般有 17 个前导零， 例如第 398346号区块哈希值为 “0000000000000000077f754f22f21629a7975cf · · · ”。按照概率计算, 每 16 次随机数搜索将会有找到一个含有一个前导零的区块哈希值， 因而比特币目前 17 位前导零哈希值要求 16^17 次随机数搜索才能找到一个合适的随机数并生成一个新的区块。由此可 见, 比特币区块链系统的安全性和不可篡改性是由 PoW 共识机制的强大算力所保证的, 任何对于区块 数据的攻击或篡改都必须重新计算该区块以及其后 所有区块的 SHA256 难题, 并且计算速度必须使得 伪造链长度超过主链, 这种攻击难度导致的成本将 远超其收益. 据估计, 截止到 2016 年 1 月, 比特币 区块链的算力已经达到 800 000 000 Gh/s, 即每秒进 行 8 × 1018 次运算, 超过全球 Top500 超级计算机 的算力总和。

###  如何用PoW记账？

前面讲解的是单节点工作量证明流程，有了这个计算流程，我们就得将其使用起来，在比特币平台中，中本聪就是运用的pow工作量证明来使全网节点达到51%及以上的共识记账，以下将介绍pow工作量证明共识是如何记账的？

1. 客户端产生新的交易，向全网广播
2. 每个节点收到请求，将交易纳入区块中
3. 每个节点通过pow工作量证明
4. 当某个节点找到了证明，向全网广播
5. 当且仅当该区块的交易是有效的且在之前中未存在的，其他节点才认同该区块的有效性
6. 接受该区块且在该区块的末尾制造新的区块

大概时序图如下：
 ![img](D:/blockchain_github/01.共识机制/imags/a2.png)​

图2：来自网络 

### 难度值

关于难度值，我们直接看公式：新难度值=旧难度值*（过去11个区块花费时长/110分钟）
 tips：难度值是随网络变动的，目的是为了在不同的网络环境下，确保每10分钟能生成一个块。
 新难度值解析：撇开旧难度值，按比特币理想情况每10分钟出块的速度，过去11个块的总花费接近110分钟，这样，这个值永远趋近于1。

目标值=最大目标值/难度值
 目标值解析：最大目标值为一个固定数，若过去11个区块花费时长少于110分钟，那么这个系数会小，目标值将会被调大些，反之，目标值会被调小，因此，比特币的难度和出块速度将成反比例适当调整出块速度。

那如何计算呢？SHA256(SHA256(Block_Header))，即只需要对区块头进行两次SHA256运算即可，得到的值和目标值进行比较，小于目标值即可。区块头中有一个重要的东西叫MerkleRoot的hash值。这个东西的意义在于：为了使区块头能体现区块所包含的所有交易，在区块的构造过程中，需要将该区块要包含的交易列表，通过Merkle Tree算法生成Merkle Root Hash，并以此作为交易列表的摘要存到区块头中。

至此，我们发现区块头中除过nonce以外，其余的数据都是明确的，解题的核心就在于不停的调整nonce的值，对区块头进行双重SHA256运算。

### 缺点

这种证明方式需要消耗大量能源(电力及计算硬件损耗)，很不环保。并且在理论上，如果集合了全网51%的算力即可对区块链网络进行有效攻击，因此许多基于比特币代码产生的、市值较小的山寨币很容易遭受攻击。由于运算时间过长，变得获得记账权的等待时间变久，交易确认周期也会变长，影响产生交易区块的效率，目前大概是每10分钟才产生一个区块，对于一些商业性项目的应用不太合适。

### 总结

PoW 共识机制是具有重要意义的创新, 其近乎 完美地整合了比特币系统的货币发行、交易支付和 验证等功能, 并通过算力竞争保障系统的安全性和 去中心性