## **POS**

PoS 全称是 Proof of Stake，中文翻译为权益证明。PoS 最早出现在点点币的创始人 Sunny King 的白皮书中，它的目的就是为了解决使用 PoW 挖矿出现大量资源浪费的问题。PoS基本思想是:当你持有币，你就拥有记账权，然后有投票权。投票权和持有币的数量是成正比的。简单理解就是持有币越多，投票的权利越大。

PoS协议的基本框架是按所有参与者的持币数量，去分配打包权和投票权。PoS中打包和投票是分开的。打包区块的人是随机选中的，其他没有被选中的用户，会成为验证者去验证创建的区块。拥有打包权的人就有资格生成新的区块，这个区块里面包含的是要处理的交易，并且有他自己的签名。拥有投票权的验证者会去投票，投票形式可以就是在被投票的区块上做个签名。投票获得多数票支持后，区块才会被加入共识，变成一个有效地区块。为了提高效率，会选举一个委员会，由他们负责投票，委员会是随机选取，但是都是持币人，为了公平性，委员会要经常轮换。见PoSe原理。

PoS 的发展经历了三个版本，第一个版本是以点点币为代表的 PoS1.0 版本，这个版本中使用的是币龄；第二个版本的代表是黑币（blackcoin），对应使用的是币数量，相当于是财产证明，后面黑币又升级到 PoS3.0，这个版本又回到了币龄。

 PoS权益证明同样需要通过计算找出合理的哈希值来完成。但不同的是权益证明机制通过节点持有加密货币的时间和数量来判断节点的权益大小。根据权益大小不同，用户之间看到的计算目标值也不同。权益大的节点，获得目标值更加简单，更容易获得下一个区块的记账权。 这种方式不需要每个节点都进行大量的运算，节省了电力能源。

### PoS原理

1. 加入PoS的都是持币人并称为验证者。
2. 在验证者中挑一个持币人给予权利生成新的区块，挑选顺序依据持币的多少。
3. 其余的持币人，也就是验证者进行对区块进行验证。验证通过生成新的区块。
4. 如果在一定时间内没有生成新区块，PoS会挑选下一个验证者，给予生成新区块的权利。
5. 以此类推，以区块链中最长的链为准。

PoS 共识本质上是采用权益证明来代替 PoW 中的基于哈希算力的工作量证明， 是由系统中具有 最高权益而非最高算力的节点获得区块记账权。 权益体现为节点对特定数量货币的所有权， 称为币龄或币天数 (Coin days)。 币龄是特定数量的币与其最后一次交易的时间长度的乘积， 每次交易都将会消耗掉特定数量的币龄。 例如， 某人在一笔交易中收到 10 个币后并持有 10 天， 则获得 100 币龄; 而后其花掉5个币后， 则消耗掉 50 币龄。 显然， 采用 PoS 共 识机制的系统在特定时间点上的币龄总数是有限的， 长期持币者更倾向于拥有更多币龄， 因此币龄可视为其在 PoS 系统中的权益。

此外， PoW 共识过程中各节点挖矿难度相同， 而 PoS 共识过程中的难度与交易输入的币龄成反比， **消耗币龄越多则挖矿难度越低**。 在PoS系统中，可用公式表示为：**Hash (block_header) < Target \* CoinAge**。我们可以看出多引入了一个变量叫做 CoinAge，也就是币龄，这里就有意思了。这个变量为会造成每个矿工看到的目标值不一样，如果你的币龄越大，也就意味着你的获得答案越容易。节点判断主链的标准也由 PoW 共识的最高 累计难度转变为最高消耗币龄， 每个区块的交易都 会将其消耗的币龄提交给该区块， 累计消耗币龄最 高的区块将被链接到主链。 你每被清空365币龄，你将会从区块中获得0.05个币的利息（可以理解为年利率5%）。由此可见， PoS 共识过程 仅依靠内部币龄和权益而不需要消耗外部算力和资 源， 从根本上解决了 PoW 共识算力浪费的问题， 并 且能够在一定程度上缩短达成共识的时间， 因而比 特币之后的许多竞争币均采用 PoS 共识机制。

PoS 似乎完美地解决了 PoW 挖矿资源浪费的问题，甚至还顺带解决了 51% 攻击的问题，我们发现，矿工挖矿的成本不再是物理设备和电费，而是虚拟代币，它的边际成本几乎为零，本质上 PoS 让挖矿者和使用者合二为一了。这也意味着如果挖矿者发起 51% 攻击，就需要拥有全网 51% 的币或币龄，这几乎不可能办到，即使你成功地实施了 51% 攻击，那么也意味着作为全网最大的持币大户的你，损失也会最大。

### 可能面临的攻击

- Long Range Attack：长程攻击就是攻击者创建了一条从创世区块开始的长区块链分支，并试图替换掉当前的合法主链。
- 无利害攻击 Nothing at Stake Attack：PoS 运行多条链的成本很低，Validator 可以向多个链投票而不会遭受任何损失，这就违反了共识协议。
- 51% Attack：一些 PoS 网络中，只需要最少 33% 的 stake 资金就能发起这样一场攻击。而且如果能吸收他人投票，攻击者甚至都不需要用自己的币去发起攻击，他们甚至还可以通过购买或贿赂的方式来获取投票。
- Low Staking Participation：在一些 PoS 网络中，只需要质押活跃在资金池中 33% 的币量就能发起一场 51% 攻击。比如，stake 率为 25%，33%* 25%=1/12，即发起一次攻击只需要该 PoS 币总供给量的 1/12。
- Private Key Attack：私钥联网后一旦被获取，攻击人就会获得 Staking 资金的所有权和签署交易的权利。即使私钥不直接控制所有 Staking 资金，获得了私钥就获得 Validation 和 Staking 的权力，方便发起攻击。

### 缺点

（1）币发行：一开始的时候，只有创始区块上有币，意味着只有这一个节点可以挖矿，所以让币分散出去才能让整个网络壮大，那么如何分散出去又是另外一个难题了。所以早期 PoS 币种基本都采用了分阶段挖矿，有的叫混合挖矿，其实，我并不同意混合挖矿这个说法，混合就意味着同时。很多币种其实是分了阶段的，即第一阶段是 PoW 挖矿，到第二阶段才是 PoS 挖矿。随着 ERC20 类型的标准合约代币的出现，这个问题被解决了，不再需要第一阶段改成 PoW，也可以将代币分散出去。
 （2）由于币龄是与时间挂钩的，这也意味着用户可以无限囤积一定的币，等过了很久再一次性挖矿发起攻击；所以解决方案是：PoS 机制需要引入一个时间上限来控制时间因素的自然增长。

（3）虽然引入了时间上下限，用户还是倾向于囤积代币，这会造成币流通的不充分；基于此，所以瑞迪币引入了币龄按时间衰减，构造了权益速度证明，鼓励用户流动代币，而不是倾向于囤积代币。

（4）离线攻击：即使引入了时间上下限，时间仍然是自然流动的，也就是可以不需要求挖矿节点长时间在线。挖矿是可以离线的，这简直是灾难，所以任意一个 PoS 机制的实践形式都必须避免这个问题，因为网络节点数量的多少直接关系到区块链网络的健壮性。

当然这些问题都不是致命问题，还记得我们一开始提到了 PoS 经历了三个版本，而第二个版本 PoS 2.0 使用的不是币龄，而直接是币的数量。这会造成完全不同的结果，上述第二、三、四问题都不存在了，似乎看起来直接使用币的数量会更好一些，但却出现了整个 PoS 机制的致命问题：Nothing at Stake，翻译过来叫做无成本利益问题。大体的意思在 PoS 系统中做任何事几乎没有成本，比如在 PoS 系统上挖矿几乎没有成本，这也就意味着分叉非常方便。

方便到什么程度呢？每个诚实矿工在产生孤块的时候都可以继续挖下去，反正也没什么成本，反正分叉链和主链都可以同时挖，也就是任何持币较少的用户都可以尝试分叉，并且把分叉链广播出去。这个时候如果其他诚实矿工看到了，第一反应也是没有成本，那么咱们也来挖吧，说不定什么时候就值钱了，意思就是说任何逐利的矿工并不会使这个系统变得更强壮稳定，而是更加的混乱。

无成本利益问题无论以币龄还是币数量作为 PoS 的参数，都无法避免。而 PoW 则没有这样的问题，我们回到 PoW 系统中来看，因为任何的分叉都会造成挖矿成本直接变成负收益，所以这会抵抗分叉的产生，矿工倾向于跟随“最长”的链。

### 总结

PoS 的区块链系统无需外部物理输入，所以它相比 PoW 更为环保不费电，并且矿工就是使用者，这会在一定程度上抵御了 51% 攻击，所以基于 PoS 机制的数字货币属于理想状态的数字货币。PoS 的缺点是缺乏工业级的区块链应用，从逻辑上来看有点循环自证明的味道，就是用自己的币来维护系统的安全，而币的安全性是由系统保证的，所以现阶段 PoS 共识机制往往不是独立运行的，而是混合了 PoW 一起运行，这就可以弥补 PoS 的缺陷。PoS 共识机制目前也出现了矿池，也可能会出现中心化挖矿的风险。虽然 PoS 共识机制未来变数依然很多，但它的可塑性比 PoW 好，技术上的探索空间大，目前 PoS 币种相比较 PoW 币种风险也较高。